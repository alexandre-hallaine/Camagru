<!DOCTYPE html>
<html lang="en">
<head>
  <title>Camagru</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <header>
    <button data-target="feed">Feed</button>
    <button data-target="create">Create</button>
    <button data-target="settings">Settings</button>
    <button id="logout">Logout</button>
  </header>


  <main>
    <section id="feed"></section>
    <section id="create" style="display:none">
      <h1>Create</h1>
      <p>Use the editor below to create a new image.</p>
    </section>
    <section id="settings" style="display:none">
      <h1>Settings</h1>
      <p>Here you can change your settings.</p>
    </section>
  </main>

  <div class="editor">
    <div>
      <div>
        <div class="wrapper">
          <video autoplay></video>
          <img id="overlay" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" />
        </div>
        <button id="snap">Take Photo</button>
      </div>

      <div>
        <canvas width="640" height="480"></canvas>
        <button id="share">Publish</button>
      </div>
    </div>

    <div id="thumbnails"></div>
  </div>

  <script type="module">
import { apiCall } from './shared.js';

document.querySelectorAll("header button").forEach(btn => {
  btn.addEventListener("click", () => {
    const targetId = btn.dataset.target;
    if (!targetId) return;
    document.querySelectorAll("main section").forEach(sec => {
      sec.style.display = sec.id === targetId ? "block" : "none";
    });
  });
});

document.getElementById("logout").addEventListener("click", async () => {
  const { ok } = await apiCall("/api/auth/logout", "POST");
  if (ok) window.location.href = "/auth/";
});

(async () => {
  const { ok, data } = await apiCall("/api/images", "GET");

  for (const image of data.images) {
    const div = document.createElement("div");
    document.querySelector("#feed").appendChild(div);

    const name = document.createElement("h3");
    name.textContent = image.username;
    div.appendChild(name);

    const img = document.createElement("img");
    img.src = image.image_data;
    div.appendChild(img);

    const like = document.createElement("button");
    like.textContent = image.liked ? 'Unlike' : 'Like';
    div.appendChild(like);
    like.addEventListener("click", async () => {
      const { ok, data } = await apiCall(`/api/images/${image.id}/like`, "POST");
      if (ok) like.textContent = data.liked ? 'Unlike' : 'Like';
    });

    console.log(image.comments);
    for (const data of image.comments) {
      const comment = document.createElement("p");
      comment.textContent = `${data.user}: ${data.body}`;
      div.appendChild(comment);
    }

    const commentInput = document.createElement("input");
    commentInput.type = "text";
    div.appendChild(commentInput);

    const commentButton = document.createElement("button");
    commentButton.textContent = "Post";
    div.appendChild(commentButton);
    commentButton.addEventListener("click", async () => {
      const { ok } = await apiCall(`/api/images/${image.id}/comment`, "POST", { body: commentInput.value });
      if (!ok) return;

      const p = document.createElement("p");
      p.textContent = `You: ${commentInput.value}`;
      div.appendChild(p);
      commentInput.value = "";
    });
  }
})();

[
  "cadre.png",
  "costumeHomme.png",
  "birthday.png"
].forEach(src => {
  const img = document.createElement("img");
  img.src = `./overlay/${src}`;
  img.onclick = () => overlay.src = img.src;
  document.getElementById("thumbnails").appendChild(img);
});

const video = document.querySelector("video");

navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream)
  .catch(err => console.error("Camera error:", err));

document.getElementById("snap").onclick = () => {
  const canvas = document.querySelector("canvas");
  canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
  if (overlay.src) canvas.getContext("2d").drawImage(overlay, 0, 0, canvas.width, canvas.height);
};

document.getElementById("share").onclick = async () => {
  await apiCall("/api/images/upload", "POST", {
    image: document.querySelector("canvas").toDataURL("image/jpeg", 0.7)
  });
};
  </script>
</body>
</html>
