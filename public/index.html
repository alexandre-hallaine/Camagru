<!DOCTYPE html>
<html lang="en">
<head>
  <title>Camagru</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <header>
    <button data-target="feed">Feed</button>
    <button data-target="create">Create</button>
    <button data-target="settings">Settings</button>
    <button id="logout">Logout</button>
  </header>


  <main>
    <section id="feed"></section>
    <section id="create" style="display:none">
      <div class="editor">
        <div>
          <div>
            <div class="wrapper">
              <video autoplay></video>
              <img id="overlay" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=" />
            </div>
            <button id="snap">Take Photo</button>
          </div>

          <div>
            <canvas width="640" height="480"></canvas>
            <button id="share">Publish</button>
          </div>
        </div>

        <div id="thumbnails"></div>
    </section>
    <section id="settings" style="display:none" class="card">
      <h2>Settings</h2>
      <form>
        <input type="email" id="email" placeholder="New email" />
        <div>
          <label for="notify-comments">Notify me by email when someone comments on my pictures</label>
          <input type="checkbox" id="notify-comments" />
        </div>
        <button type="submit">Update</button>
      </form>
    </section>
  </main>

  </div>

  <script type="module">
import { apiCall } from './shared.js';

let logged = false;

(async () => {
  const { ok } = await apiCall("/api/auth/validate", "GET");
  if (ok) {
    logged = true;
    return;
  }

  document.querySelector("header button#logout").textContent = "Login";
  document.querySelector("header button[data-target='settings']").remove();
  document.querySelector("header button[data-target='create']").remove();
})();

document.querySelectorAll("header button").forEach(btn => {
  btn.addEventListener("click", () => {
    const targetId = btn.dataset.target;
    if (!targetId) return;
    document.querySelectorAll("main section").forEach(sec => {
      sec.style.display = sec.id === targetId ? "block" : "none";
    });
  });
});

document.getElementById("logout").addEventListener("click", async () => {
  const { ok } = await apiCall("/api/auth/logout", "POST");
  if (ok) window.location.href = "/auth/";
});

(async () => {
  let { ok, data } = await apiCall("/api/settings", "GET");
  if (!ok) return;

  document.getElementById("email").value = data.email;
  document.getElementById("notify-comments").checked = data.notify_comments;
})();

document.querySelector("section#settings form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const { ok, data } = await apiCall("/api/settings", "POST", {
    email: document.getElementById("email").value,
    notify_comments: document.getElementById("notify-comments").checked
  });

  if (!ok) alert(data.message);
  else alert("Settings updated");
});

(async () => {
  const { ok, data } = await apiCall("/api/images", "GET");

  for (const image of data.images) {
    const div = document.createElement("div");
    document.querySelector("#feed").appendChild(div);
    div.classList.add("card");

    const img = document.createElement("img");
    img.src = image.content;
    div.appendChild(img);

    const action = document.createElement("div");
    div.appendChild(action);
    action.classList.add("action");

    const name = document.createElement("h3");
    name.textContent = image.user.username;
    action.appendChild(name);

    const like = document.createElement("button");
    like.textContent = image.liked ? 'Unlike' : 'Like';
    action.appendChild(like);
    like.addEventListener("click", async () => {
      const { ok, data } = await apiCall(`/api/images/${image.id}/like`, "POST");
      if (ok) like.textContent = data.liked ? 'Unlike' : 'Like';
    });

    const comments = document.createElement("div");
    div.appendChild(comments);
    comments.classList.add("comments");

    const commentInput = document.createElement("input");
    commentInput.type = "text";
    action.appendChild(commentInput);

    const commentButton = document.createElement("button");
    commentButton.textContent = "Post";
    action.appendChild(commentButton);
    commentButton.addEventListener("click", async () => {
      const { ok } = await apiCall(`/api/images/${image.id}/comment`, "POST", { body: commentInput.value });
      if (!ok) return;

      const p = document.createElement("p");
      p.textContent = `You: ${commentInput.value}`;
      comments.appendChild(p);
      commentInput.value = "";
    });

    for (const data of image.comments) {
      const comment = document.createElement("p");
      comment.textContent = `${data.user.username}: ${data.body}`;
      comments.appendChild(comment);
    }
  }
})();

[
  "cadre.png",
  "costumeHomme.png",
  "birthday.png"
].forEach(src => {
  const img = document.createElement("img");
  img.src = `./overlay/${src}`;
  img.onclick = () => overlay.src = img.src;
  document.getElementById("thumbnails").appendChild(img);
});

const video = document.querySelector("video");

navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream)
  .catch(err => console.error("Camera error:", err));

document.getElementById("snap").onclick = () => {
  const canvas = document.querySelector("canvas");
  canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
  if (overlay.src) canvas.getContext("2d").drawImage(overlay, 0, 0, canvas.width, canvas.height);
};

document.getElementById("share").onclick = async () => {
  await apiCall("/api/images", "POST", {
    image: document.querySelector("canvas").toDataURL("image/jpeg", 0.7)
  });
};
  </script>
</body>
</html>
